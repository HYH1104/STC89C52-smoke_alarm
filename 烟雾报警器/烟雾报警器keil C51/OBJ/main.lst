C51 COMPILER V9.57.0.0   MAIN                                                              04/02/2021 00:07:45 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\OBJ\main.obj
COMPILER INVOKED BY: D:\Keil uvision5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\SRC) DEBUG OBJECTEXTEND P
                    -RINT(.\OBJ\main.lst) TABS(2) OBJECT(.\OBJ\main.obj)

line level    source

   1          #include "REG51.h"
   2          #include "oled.h"
   3          #include "bmp.h"
   4          #include "intrins.h"
   5          //ADC0832端口引脚定义
   6          sbit CS =P3^0;       //将CS位定义为P3.4引脚
   7          sbit CLK=P3^6;      //将CLK位定义为P1.0引脚
   8          sbit DIO=P3^7;       //将DIO位定义为P1.1引脚
   9          //风扇，蜂鸣器端口引脚定义
  10          sbit fengs =P1^5;       //将CS位定义为P3.4引脚
  11          sbit fengm =P1^6;      //将CLK位定义为P1.0引脚
  12          //全局变量声明
  13          unsigned char code digit[10]={"0123456789"};   //定义字符数组显示数字
  14          unsigned char code Str[]={"YWND="};            //说明显示的是电压
  15          
  16          //液晶端口定义
  17          sbit RS=P2^0;           //寄存器选择位,将RS位定义为P2.0引脚
  18          sbit RW=P2^1;           //读写选择位,将RW位定义为P2.1引脚
  19          sbit E=P2^2;            //使能信号位,将E位定义为P2.2引脚
  20          sbit BF=P0^7;           //忙碌标志位,,将BF位定义为P0.7引脚
  21          /*****************************************************
  22          函数功能:延时1ms
  23          (3j+2)*i=(3×33+2)×10=1010(微秒),可以认为是1毫秒
  24          ***************************************************/
  25          void delay1ms()
  26          {
  27   1         unsigned char i,j; 
  28   1        for(i=0;i<10;i++)
  29   1         for(j=0;j<33;j++)
  30   1          ;   
  31   1       }
  32          /*****************************************************
  33          函数功能:延时若干毫秒
  34          入口参数:n
  35          ***************************************************/
  36           void delaynms(unsigned char n)
  37           {
  38   1         unsigned char i;
  39   1       for(i=0;i<n;i++)
  40   1          delay1ms();
  41   1       }
  42          /*****************************************************
  43          函数功能:判断液晶模块的忙碌状态
  44          返回值:result｡result=1,忙碌;result=0,不忙
  45          ***************************************************/
  46          bit BusyTest(void)
  47            {
  48   1          bit result;
  49   1       RS=0;       //根据规定,RS为低电平,RW为高电平时,可以读状态
  50   1          RW=1;
  51   1          E=1;        //E=1,才允许读写
  52   1          _nop_();   //空操作
  53   1          _nop_();
  54   1          _nop_(); 
C51 COMPILER V9.57.0.0   MAIN                                                              04/02/2021 00:07:45 PAGE 2   

  55   1          _nop_();   //空操作四个机器周期,给硬件反应时间 
  56   1          result=BF;  //将忙碌标志电平赋给result
  57   1         E=0;         //将E恢复低电平
  58   1         return result;
  59   1        }
  60          /*****************************************************
  61          函数功能:将模式设置指令或显示地址写入液晶模块
  62          入口参数:dictate
  63          ***************************************************/
  64          void WriteInstruction (unsigned char dictate)
  65          {   
  66   1          while(BusyTest()==1);   //如果忙就等待
  67   1        RS=0;                  //根据规定,RS和R/W同时为低电平时,可以写入指令
  68   1        RW=0;   
  69   1        E=0;                   //E置低电平(根据表8-6,写指令时,E为高脉冲,
  70   1                                 // 就是让E从0到1发生正跳变,所以应先置"0"
  71   1        _nop_();
  72   1        _nop_();               //空操作两个机器周期,给硬件反应时间
  73   1        P0=dictate;            //将数据送入P0口,即写入指令或地址
  74   1        _nop_();
  75   1        _nop_();
  76   1        _nop_();
  77   1        _nop_();               //空操作四个机器周期,给硬件反应时间
  78   1        E=1;                   //E置高电平
  79   1        _nop_();
  80   1        _nop_();
  81   1        _nop_();
  82   1        _nop_();               //空操作四个机器周期,给硬件反应时间
  83   1         E=0;                  //当E由高电平跳变成低电平时,液晶模块开始执行命令
  84   1       }
  85          /*****************************************************
  86          函数功能:指定字符显示的实际地址
  87          入口参数:x
  88          ***************************************************/
  89           void WriteAddress(unsigned char x)
  90           {
  91   1           WriteInstruction(x|0x80); //显示位置的确定方法规定为"80H+地址码x"
  92   1       }
  93          /*****************************************************
  94          函数功能:将数据(字符的标准ASCII码)写入液晶模块
  95          入口参数:y(为字符常量)
  96          ***************************************************/
  97           void WriteData(unsigned char y)
  98           {
  99   1          while(BusyTest()==1);  
 100   1         RS=1;           //RS为高电平,RW为低电平时,可以写入数据
 101   1         RW=0;
 102   1         E=0;            //E置低电平(根据表8-6,写指令时,E为高脉冲,
 103   1                           // 就是让E从0到1发生正跳变,所以应先置"0"
 104   1         P0=y;           //将数据送入P0口,即将数据写入液晶模块
 105   1         _nop_();
 106   1         _nop_();
 107   1          _nop_();
 108   1           _nop_();       //空操作四个机器周期,给硬件反应时间
 109   1         E=1;           //E置高电平
 110   1         _nop_();
 111   1         _nop_();
 112   1         _nop_();
 113   1        _nop_();        //空操作四个机器周期,给硬件反应时间
 114   1        E=0;            //当E由高电平跳变成低电平时,液晶模块开始执行命令
 115   1       }
 116          /*****************************************************
C51 COMPILER V9.57.0.0   MAIN                                                              04/02/2021 00:07:45 PAGE 3   

 117          函数功能:对LCD的显示模式进行初始化设置
 118          ***************************************************/
 119          void LcdInitiate(void)
 120          {
 121   1          delaynms(15);               //延时15ms,首次写指令时应给LCD一段较长的反应时间
 122   1          WriteInstruction(0x38);     //显示模式设置:16×2显示,5×7点阵,8位数据接口
 123   1       delaynms(5);                //延时5ms ,给硬件一点反应时间
 124   1          WriteInstruction(0x38);
 125   1       delaynms(5);               //延时5ms ,给硬件一点反应时间
 126   1       WriteInstruction(0x38);     //连续三次,确保初始化成功
 127   1       delaynms(5);               //延时5ms ,给硬件一点反应时间
 128   1       WriteInstruction(0x0c);     //显示模式设置:显示开,无光标,光标不闪烁
 129   1       delaynms(5);               //延时5ms ,给硬件一点反应时间
 130   1       WriteInstruction(0x06);     //显示模式设置:光标右移,字符不移
 131   1       delaynms(5);                //延时5ms ,给硬件一点反应时间
 132   1       WriteInstruction(0x01);     //清屏幕指令,将以前的显示内容清除
 133   1       delaynms(5);             //延时5ms ,给硬件一点反应时间
 134   1       }
 135          
 136          /*****************************************************
 137          函数功能:显示电压符号
 138          ***************************************************/   
 139          void display_volt(void)
 140           {
 141   1        unsigned char i;
 142   1        WriteAddress(0x03);    //写显示地址,将在第2行第1列开始显示
 143   1        i = 0;                //从第一个字符开始显示
 144   1        while(Str[i] != '\0')  //只要没有写到结束标志,就继续写
 145   1         {      
 146   2         WriteData(Str[i]);   //将字符常量写入LCD
 147   2         i++;                 //指向下一个字符    
 148   2        } 
 149   1      }
 150          /*****************************************************
 151          函数功能:显示电压的小数点
 152          ***************************************************/   
 153          void  display_dot(void)
 154          {         
 155   1        WriteAddress(0x0b);   //写显示地址,将在第1行第11列开始显示     
 156   1        WriteData('.');       //将小数点的字符常量写入LCD  
 157   1      }
 158          /*****************************************************
 159          函数功能:显示电压的单位(V)
 160          ***************************************************/   
 161          void  display_V(void)
 162          {
 163   1          WriteAddress(0x0e); //写显示地址,将在第2行第15列开始显示 
 164   1        WriteData('%');     //将字符常量写入LCD   
 165   1         
 166   1      }
 167          /*****************************************************
 168          函数功能:显示电压的整数部分
 169          入口参数:x
 170          ***************************************************/ 
 171          void display1(unsigned char x)
 172          {
 173   1       unsigned char i,j,k;
 174   1       i=x/100;            //取百位
 175   1       j=(x%100)/10;            //取十位
 176   1       k=((x%100)%10);           //取个位
 177   1       if(i==1){
 178   2       WriteAddress(0x08);    //写显示地址,将在第2行第9列开始显示
C51 COMPILER V9.57.0.0   MAIN                                                              04/02/2021 00:07:45 PAGE 4   

 179   2       WriteData(digit[i]);     //将数字字符常量写入LCD
 180   2       WriteData(digit[j]);     //将数字字符常量写入LCD
 181   2       WriteData(digit[k]);     //将数字字符常量写入LCD
 182   2       }
 183   1       else
 184   1       {
 185   2       WriteAddress(0x08);    //写显示地址,将在第2行第9列开始显示
 186   2       WriteData(' ');     //将数字字符常量写入LCD
 187   2       WriteData(digit[j]);     //将数字字符常量写入LCD
 188   2       WriteData(digit[k]);     //将数字字符常量写入LCD
 189   2       }
 190   1      }
 191          /*****************************************************
 192          函数功能:显示电压的小数数部分
 193          入口参数:x
 194          ***************************************************/ 
 195           void display2(unsigned char x)
 196          {
 197   1        unsigned char i,j;
 198   1       i=x/10;            //取十位(小数点后第一位)
 199   1       j=x%10;            //取个位(小数点后第二位)
 200   1       WriteAddress(0x0c);      //写显示地址,将在第1行第13列开始显示
 201   1       WriteData(digit[i]);     //将小数部分的第一位数字字符常量写入LCD
 202   1       WriteData(digit[j]);     //将小数部分的第一位数字字符常量写入LCD
 203   1      }
 204          /*****************************************************
 205          函数功能:将模拟信号转换成数字信号
 206          ***************************************************/ 
 207          unsigned char  A_D()
 208          {
 209   1        unsigned char i,dat;
 210   1         CS=1;   //一个转换周期开始
 211   1         CLK=0;  //为第一个脉冲作准备
 212   1         CS=0;  //CS置0,片选有效
 213   1         DIO=1;    //DIO置1,规定的起始信号  
 214   1         CLK=1;   //第一个脉冲
 215   1         CLK=0;   //第一个脉冲的下降沿,此前DIO必须是高电平
 216   1         DIO=1;   //DIO置1, 通道选择信号  
 217   1         CLK=1;   //第二个脉冲,第2､3个脉冲下沉之前,DI必须跟别输入两位数据用于选择
             -道,这里选通道CH0 
 218   1         CLK=0;   //第二个脉冲下降沿
 219   1          
 220   1         DIO=0;   //DI置0,选择通道0
 221   1         CLK=1;    //第三个脉冲
 222   1         CLK=0;    //第三个脉冲下降沿
 223   1         DIO=1;    //第三个脉冲下沉之后,输入端DIO失去作用,应置1
 224   1         CLK=1;    //第四个脉冲
 225   1         for(i=0;i<8;i++)  //高位在前
 226   1          {
 227   2            CLK=1;         //第四个脉冲
 228   2            CLK=0; 
 229   2            dat<<=1;       //将下面储存的低位数据向右移
 230   2         dat|=(unsigned char)DIO;   //将输出数据DIO通过或运算储存在dat最低位 
 231   2          }             
 232   1          CS=1;          //片选无效 
 233   1        return dat;  //将读书的数据返回     
 234   1        }
 235          /*****************************************************
 236          函数功能:主函数
 237          ***************************************************/ 
 238          main(void)
 239          {
C51 COMPILER V9.57.0.0   MAIN                                                              04/02/2021 00:07:45 PAGE 5   

 240   1        unsigned int AD_val;    //储存A/D转换后的值
 241   1        unsigned int nongdu;    //浓度
 242   1        unsigned char Int,Dec;   //分别储存转换后的整数部分与小数部分
 243   1         LcdInitiate();         //将液晶初始化
 244   1         delaynms(5);           //延时5ms给硬件一点反应时间 
 245   1         display_volt();        //显示温度说明
 246   1         display_dot();         //显示温度的小数点
 247   1         display_V();           //显示温度的单位
 248   1         OLED_Init();
 249   1         fengm=0; fengs=0;
 250   1         while(1)
 251   1            {
 252   2          OLED_ShowCHinese(24,0,0);
 253   2          OLED_ShowCHinese(40,0,1);
 254   2          OLED_ShowCHinese(56,0,2);
 255   2          OLED_ShowCHinese(72,0,3);
 256   2          OLED_ShowCHinese(88,0,4);
 257   2          OLED_ShowString(16,2,"201707154105");
 258   2          OLED_ShowCHinese(40,4,5);
 259   2          OLED_ShowCHinese(72,4,6);
 260   2              
 261   2          AD_val= A_D();    //进行A/D转换
 262   2          Int=(AD_val)/51;  //计算整数部分  
 263   2          Dec=(AD_val%51)*100/51;    //计算小数部分
 264   2          Int=(100*Int+Dec)/5;
 265   2          Dec=((100*Int+Dec)%5)*100/5;    //计算小数部分
 266   2          display1(Int);     //显示整数部分
 267   2          display2(Dec);     //显示小数部分
 268   2          delaynms(250);     //延时250ms
 269   2          nongdu=Int+(Dec/100);
 270   2          if(nongdu > 50)
 271   2          {
 272   3          fengs=1;
 273   3          } 
 274   2          else
 275   2          {
 276   3          fengs=0;
 277   3          }
 278   2          if(nongdu > 70)
 279   2          {
 280   3          fengm=1;
 281   3          } 
 282   2          else
 283   2          {
 284   3          fengm=0;
 285   3          }
 286   2        }
 287   1            
 288   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    616    ----
   CONSTANT SIZE    =   2077    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
